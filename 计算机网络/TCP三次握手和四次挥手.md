## 三次握手

![image-20220221205355246](D:\图片\typora\image-20220221205355246.png)

1. 客户端向服务器端发送请求连接报文，等待服务器确认

   标志位SYN=1，表示请求建立连接

   起始序号Seq=x，一般取随机数

   随后客户端进入SYN-SENT阶段

2. 服务器收到客户端发送的请求报文，如同意连接，就向客户端发回确认报文段

   标志位SYN=1，ACK=1，表示确认客户端的报文 Seq 序号有效，服务器能正常接收客户端发送的数据，并同意创建新连接；

   起始序号Seq=y，一般取随机数

   确认序号Ack=x+1，表示收到客户端的序号Seq并将其值加1作为确认号Ack的值，随后进入SYN-RECV阶段

3. 客户端收到确认报文段后，还要向服务器给出确认，当服务器端收到客户端发送的确认收到服务器端报文的确认报文后，建立连接，完成三次握手

   标志位ACK=1，表示确认收到服务器端统一连接的信号

   起始序号Seq=x+1，表示收到服务器端的确认信号Ack,并将其值作为自己的序号值

   确认号Ack=y+1，表示收到服务器端序号seq，并将其值加1作为自己的确认号Ack的值

   随后客户端进入ESTABLISHED阶段

seq

序号字段：TCP是面向字节流的，TCP连接传送的数据流中的每个字节都编上一个序号。序号字段的值是指本报文段发送数据的第一个字节的序号

ack

确认号字段：期望收到对方发送的下一个报文段的数据的第一个字节的序号

ACK

确认位：只有当ACK=1时确认号字段才有效。当ACK=0时，确认号无效。TCP规定，在连接建立后所有传送报文段都必须将ACK置为1

SYN

同步位：SYN=1表示这是一个连接请求或连接接收报文。当SYN=1，ACK=0时，表明这是一个连接请求报文，当SYN=1，ACK=1时，表明这是一个连接接收报文。

## 四次挥手

![image-20220221202558857](D:\图片\typora\image-20220221202558857.png)

四次挥手即TCP连接的释放，这里假设客户端主动释放连接。在挥手前主动释放连接的客户端结束ESTABLISHED阶段，随后开始四次挥手：

1. 客户端向服务器发送连接释放报文段，停止发送数据，主动关闭TCP连接

   标记位FIN=1，表示请求释放连接

   序号Seq=u

   客户端进入FIN-WAIT-1阶段，即半关闭阶段，并且停止向服务器发送通信数据

2. 服务器收到连接释放报文段后即发出确认报文段，客户端到服务器端这个方向的连接就释放了--半关闭状态

   标记位ACK=1，表示接收到客户端释放连接的请求

   序号Seq=v

   确认号Ack=u+1，表示收到客户端报文的基础上，将其序号Seq的值加1作为本段报文确认号Ack的值

   随后服务器开始准备释放服务器端到客户端方向上的连接，进入CLOSE-WAIT阶段

   客户端收到服务器发送过来的TCP报文后，确认服务器已经收到了客户端连接释放的请求，随后客户端结束FIN-WAIT-1阶段，进入FIN-WAIT-2阶段

3. 若服务器已经没有要向客户机发送的数据，就发出连接释放报文段通知TCP释放连接

   标记位FIN=1，ACK=1，表示服务器请求客户端释放连接

   序号Seq=w

   确认号Ack=u+1，表示是在收到客户端报文的基础上，将其序号Seq的值加1作为本段报文确认号Ack的值

4. 客户端回送一个确认报文段，等到时间达到计时器设置的2MSL（最长报文段寿命）后，连接彻底关闭

   标记位ACK=1，表示接收到服务器释放连接的请求

   序号Seq=u+1，表示是在已收到服务器报文的基础上，将其确认号Ack的值作为本段序号的值

   确认号Ack=w+1，表示是在收到服务器报文的基础上，将其序号Seq的值加1作为本段报文确认号的值

